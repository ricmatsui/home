---

- name: set dns record
  community.general.cloudflare_dns:
    zone: "{{ config.cloudflare.zone }}"
    record: "temporal.{{ config.domain }}"
    type: A
    value: "{{ config.ip }}"
    api_token: "{{ config.cloudflare.api_key }}"
  delegate_to: localhost

- name: set ui dns record
  community.general.cloudflare_dns:
    zone: "{{ config.cloudflare.zone }}"
    record: "temporal-ui.{{ config.domain }}"
    type: A
    value: "{{ config.ip }}"
    api_token: "{{ config.cloudflare.api_key }}"
  delegate_to: localhost

- name: create config directory
  ansible.builtin.file:
    path: /mnt/gluster/temporal/dynamicconfig
    owner: pi
    group: pi
    state: directory

- name: create directories
  ansible.builtin.file:
    path: "/mnt/gluster/temporal/{{ item }}"
    owner: 999
    group: pi
    state: directory
  loop:
    - db
    - backups

- name: create dynamic config
  ansible.builtin.copy:
    dest: /mnt/gluster/temporal/dynamicconfig/development.yml
    content: |
      limit.maxIDLength:
        - value: 255
          constraints: {}

- name: mirror image
  include_tasks: tasks/docker_mirror_image.yml
  vars:
    fact: "{{ item.fact }}"
    name: "{{ item.name }}"
    source: "{{ item.source }}"
    image_id: "{{ item.image_id }}"
  loop:
    - fact: temporal_server_image
      name: temporal-server
      source: temporalio/auto-setup:1.27.2
      image_id: sha256:b44cbfeb43dbeae42db113b44fb8414c3452f05643b3d6b1592f955277d73526

    - fact: temporal_db_image
      name: temporal-db
      source: postgres:16.8
      image_id: sha256:5779f428edb411216d6960f2721974d7e71e124e3c41a3e625e47a9072949ed6

    - fact: temporal_db_backup_image
      name: temporal-db-backup
      source: prodrigestivill/postgres-backup-local:16
      image_id: sha256:a0103fbce0c48ccc7693ddbb2a2bfa733048db845354f635efef9e4566de185d

    - fact: temporal_ui_image
      name: temporal-ui
      source: temporalio/ui:2.37.2
      image_id: sha256:3d7b36849d7ca5245f59f6ab558bebbd6b83aa1518f4505e97927419360d1f25

- name: deploy stack
  community.general.docker_stack:
    name: temporal
    prune: yes
    resolve_image: always
    compose:
      - version: '3.8'
        services:
          temporal-server:
            image: "{{ temporal_server_image }}"
            environment:
              DB: postgres12
              DB_PORT: '5432'
              POSTGRES_USER: temporal
              POSTGRES_PWD: "{{ config.temporal.postgres_password }}"
              POSTGRES_SEEDS: temporal_temporal-db
              DYNAMIC_CONFIG_FILE_PATH: config/dynamicconfig/development.yml
              BIND_ON_IP: 0.0.0.0
              TEMPORAL_BROADCAST_ADDRESS: 127.0.0.1
              TEMPORAL_ADDRESS: temporal_temporal-server:7233
              TEMPORAL_CLI_ADDRESS: temporal_temporal-server:7233
            networks:
              - temporal
              - traefik_traefik
            volumes:
              - /mnt/gluster/temporal/dynamicconfig:/etc/temporal/config/dynamicconfig
            deploy:
              mode: replicated
              replicas: 1
              labels:
                - "traefik.enable=true"
                - "traefik.tcp.routers.temporal.rule=HostSNI(`*`)"
                - "traefik.tcp.routers.temporal.middlewares=traefik-internal-tcp"
                - "traefik.tcp.routers.temporal.entrypoints=temporal"
                - "traefik.tcp.services.temporal.loadbalancer.server.port=7233"
              placement:
                constraints:
                  - 'node.labels.home.instance_type == mbp'
                  - 'node.labels.home.instance_size == large'
              resources:
                limits:
                  cpus: '1.00'
                  memory: 250M
              restart_policy:
                delay: 30s
              update_config:
                order: stop-first

          temporal-db:
            image: "{{ temporal_db_image }}"
            environment:
              POSTGRES_USER: temporal
              POSTGRES_PASSWORD: "{{ config.temporal.postgres_password }}"
            networks:
              - temporal
            volumes:
              - /mnt/gluster/temporal/db:/var/lib/postgresql/data
            deploy:
              mode: replicated
              replicas: 1
              placement:
                constraints:
                  - 'node.labels.home.instance_type == mbp'
              resources:
                limits:
                  cpus: '1.00'
                  memory: 200M
              restart_policy:
                delay: 20s
              update_config:
                order: stop-first

          temporal-db-backup:
            image: "{{ temporal_db_backup_image }}"
            environment:
              POSTGRES_HOST: temporal_temporal-db
              POSTGRES_DB: temporal
              POSTGRES_USER: temporal
              POSTGRES_PASSWORD: "{{ config.temporal.postgres_password }}"
            networks:
              - temporal
            volumes:
              - /mnt/gluster/temporal/backups:/backups
            deploy:
              mode: replicated
              replicas: 1
              placement:
                constraints:
                  - 'node.labels.home.instance_type == mbp'
                  - 'node.labels.home.instance_size == large'
              resources:
                limits:
                  cpus: '1.00'
                  memory: 100M
              restart_policy:
                delay: 60s
              update_config:
                order: stop-first

          temporal-ui:
            image: "{{ temporal_ui_image }}"
            environment:
              TEMPORAL_ADDRESS: temporal_temporal-server:7233
              TEMPORAL_CORS_ORIGINS: "https://temporal-ui.{{ config.domain }}"
              TEMPORAL_NOTIFY_ON_NEW_VERSION: 'false'
            networks:
              - temporal
              - traefik_traefik
            logging:
              driver: none
            deploy:
              mode: replicated
              replicas: 1
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.temporal-ui.rule=Host(`temporal-ui.{{ config.domain }}`)"
                - "traefik.http.routers.temporal-ui.middlewares=traefik-internal,traefik-forward-auth"
                - "traefik.http.routers.temporal-ui.entrypoints=websecure"
                - "traefik.http.routers.temporal-ui.tls.certresolver=letsencrypt"
                - "traefik.http.services.temporal-ui.loadbalancer.server.port=8080"
              placement:
                constraints:
                  - 'node.labels.home.instance_type == mbp'
                  - 'node.labels.home.instance_size == large'
              resources:
                limits:
                  cpus: '1.00'
                  memory: 125M
              restart_policy:
                delay: 10m
              update_config:
                order: stop-first
        networks:
          temporal: {}
          traefik_traefik:
            external: true

- name: configure backup
  ansible.builtin.copy:
    dest: /mnt/gluster/rclone/scripts/temporal.sh
    mode: u=rwx,g=rx,o=rx
    content: |
      #!/bin/bash
      . /mnt/gluster/rclone/functions

      rclone copy --immutable /mnt/gluster/temporal/backups/monthly \
        :s3:/$ARCHIVE_PATH/temporal/backups/monthly \
        --exclude "temporal-latest.sql.gz" \
        --min-age 1d
