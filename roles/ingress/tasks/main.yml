---

- name: set dns record
  community.general.cloudflare_dns:
    zone: "{{ config.cloudflare.zone }}"
    record: "{{ item.record }}"
    type: A
    value: "{{ item.value }}"
    api_token: "{{ config.cloudflare.api_key }}"
  run_once: true
  delegate_to: localhost
  loop:
    - record: "{{ config.ingress.dns_name }}"
      value: "{{ config.ingress.ip }}"

    - record: "ingress.{{ config.domain }}"
      value: "{{ config.ip }}"
  tags: ingress_dns_records

- name: install
  ansible.builtin.apt:
    name:
      - wireguard
  notify: ingress_systemd_reload

- name: ipv4 forward
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    reload: yes
  notify: ingress_service_restart
  when: ingress_host_candidate

- name: ipv6 forward
  ansible.posix.sysctl:
    name: net.ipv6.conf.all.forwarding
    value: '1'
    state: present
    reload: yes
  notify: ingress_service_restart
  when: ingress_host_candidate

- name: create vpn host directories
  ansible.builtin.file:
    path: "{{ item }}"
    owner: 1000
    group: 1000
    state: directory
  run_once: true
  loop:
    - /mnt/gluster/vpn-ui/wireguard
  when: ingress_host_candidate

- name: check vpn host configuration
  ansible.builtin.stat:
    path: /mnt/gluster/vpn-ui/wireguard/vpn-host.conf
  run_once: true
  delegate_to: "{{
    groups['ingress_peers']
    |map('extract', hostvars)
    |selectattr('ingress_host_candidate', 'equalto', true)
    |map(attribute='inventory_hostname')
    |first
  }}"
  register: vpn_host_config

- name: configure vpn host
  ansible.builtin.copy:
    dest: /mnt/gluster/vpn-ui/wireguard/vpn-host.conf
    content: |
      [Interface]
      Address = {{ config.ip }}/24
      ListenPort = {{ config.vpn.listen_port }}
      PrivateKey = {{ config.vpn.private_key }}

      {% for peer in config.vpn.initial_peers %}
      [Peer]
      PublicKey = {{ peer.public_key }}
      AllowedIPs = {{ peer.ip }}/32

      {% endfor %}

      {% for peer in groups['ingress_peers'] %}
      [Peer]
      PublicKey = {{ hostvars[peer]['vpn_peer_public_key'] }}
      AllowedIPs = {{ hostvars[peer]['vpn_peer_ip'] }}/32

      {% endfor %}
    owner: root
    group: root
    mode: u=rw,g=,o=
  delegate_to: "{{
    groups['ingress_peers']
    |map('extract', hostvars)
    |selectattr('ingress_host_candidate', 'equalto', true)
    |map(attribute='inventory_hostname')
    |first
  }}"
  run_once: true
  when: not vpn_host_config.stat.exists

- name: symlink vpn host configuration
  ansible.builtin.file:
    src: /mnt/gluster/vpn-ui/wireguard/vpn-host.conf
    dest: /etc/wireguard/vpn-host.conf
    owner: root
    group: root
    mode: u=rw,g=,o=
    state: link
  notify: ingress_service_restart
  when: ingress_host_candidate

- name: configure vpn peer network
  ansible.builtin.copy:
    dest: /etc/wireguard/vpn-peer.conf
    content: |
      [Interface]
      PrivateKey = {{ vpn_peer_private_key }}
      Address = {{ vpn_peer_ip }}/32
      ListenPort = {{ config.vpn.listen_port }}

      [Peer]
      PublicKey = {{ config.vpn.public_key }}
      Endpoint = {{ config.ingress.ip }}:{{ config.vpn.listen_port }}
      AllowedIPs = {{ config.ip }}/32
      PersistentKeepalive = 25
    owner: root
    group: root
    mode: u=rw,g=,o=
  notify: ingress_systemd_reload

- ansible.builtin.blockinfile:
    path: /etc/nftables.conf
    block: |
      add table wireguard-nat

      table ip wireguard-nat {
        chain prerouting {
          type nat hook prerouting priority -100; policy accept;
        }

        chain postrouting {
          type nat hook postrouting priority 100; policy accept;
          oifname "{{ ingress_interface }}" masquerade
        }
      }
  notify: ingress_nftables_restart
  when: ingress_host_candidate

- name: enable nftables
  ansible.builtin.systemd:
    name: nftables
    enabled: true
  when: ingress_host_candidate

- name: configure vpn host sync service
  ansible.builtin.copy:
    dest: /etc/systemd/system/vpn-host-sync.service
    content: |
      [Unit]
      Description=Sync vpn host config
      After=wg-quick@vpn-host.service

      [Service]
      Type=oneshot
      ExecStart=/bin/bash -c '/usr/bin/wg show vpn-host >/dev/null 2>&1 || exit 0; /usr/bin/wg syncconf vpn-host <(/usr/bin/wg-quick strip vpn-host)'
  notify: ingress_vpn_host_sync_restart
  when: ingress_host_candidate

- name: configure vpn host sync timer
  ansible.builtin.copy:
    dest: /etc/systemd/system/vpn-host-sync.timer
    content: |
      [Unit]
      Description=Sync vpn host config

      [Timer]
      OnCalendar=*-*-* *:*:30
      RandomizedDelaySec=5s
      Persistent=true


      [Install]
      WantedBy=timers.target
  notify: ingress_vpn_host_sync_restart
  when: ingress_host_candidate

- name: enable vpn host sync timer
  ansible.builtin.systemd:
    name: vpn-host-sync.timer
    enabled: true
  when: ingress_host_candidate

- name: create bastion user
  ansible.builtin.user:
    name: bastion
    uid: 2000
  tags: bastion_user
  when: ingress_host_candidate

- name: authorize bastion keys
  ansible.posix.authorized_key:
    user: bastion
    state: present
    key: "{{ config.authorized_keys|join('\n') }}"
  tags: bastion_user
  when: ingress_host_candidate

- name: create network configuration directory
  ansible.builtin.file:
    path: /etc/systemd/system/wg-quick@.service.d
    owner: root
    group: root
    state: directory
  notify: ingress_systemd_reload

- name: configure network service
  ansible.builtin.copy:
    dest: /etc/systemd/system/wg-quick@.service.d/override.conf
    content: |
      [Unit]
      StartLimitIntervalSec=0

      [Service]
      Restart=on-failure
      RestartSec=5s
  notify: ingress_systemd_reload

- name: create ingress script
  ansible.builtin.copy:
      dest: /opt/ingress.sh
      src: ingress.sh
      owner: root
      group: root
      mode: u=rwx,g=r,o=r
  notify: ingress_service_restart
  tags: enable_ingress_service

- name: configure ingress service
  ansible.builtin.copy:
    dest: /etc/systemd/system/ingress.service
    content: |
      [Unit]
      Description=Ingress
      After=network-online.target

      [Install]
      WantedBy=multi-user.target

      [Service]
      Type=simple
      ExecStart=/opt/ingress.sh
      Restart=always
      RestartSec=5s

      Environment=INTERFACE={{ ingress_interface }}
      Environment=INGRESS_IP={{ config.ingress.ip }}
  notify: ingress_service_restart
  tags: enable_ingress_service

- name: enable ingress service
  ansible.builtin.systemd:
    name: ingress
    enabled: true
  notify: ingress_service_restart
  tags: enable_ingress_service
